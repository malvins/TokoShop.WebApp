@page "/products/add"
@using System.ComponentModel.DataAnnotations;
@using TokoShop.WebApp.Models.Products;
@inject Services.IProductService ProductService
@inject NavigationManager NavigationManager

<MudContainer Class="mt-2 px-8" MaxWidth="MaxWidth.False">
    <MudBreadcrumbs Items="BreadCrumbs">
        <ItemTemplate Context="item">
            <MudLink Href="@item.Href">@item.Text.ToUpper()</MudLink>
        </ItemTemplate>
    </MudBreadcrumbs>
    <MudGrid>
        <MudItem xs="12" sm="7">
            <MudPaper Class="pa-4">
                <MudText Align="Align.Center" Class="mb-n4">ReadOnly Form</MudText>
                <MudForm @ref="form" @bind-IsValid="@IsSuccess" Model="@Product">
                    <MudTextField T="string" @bind-Value="Product.Name" Label="Name" For="@(() => Product.Name)" />
                    <MudTextField T="string" @bind-Value="Product.Description" Label="Description" Lines="2" For="@(() => Product.Description)" />
                    <MudTextField T="string" @bind-Value="Product.ImageUrl" Label="Image Url" For="@(() => Product.ImageUrl)" />
                </MudForm>
            </MudPaper>
            <MudPaper Class="d-flex pa-2 mt-4 flex-row-reverse">
                <MudButton Variant="Variant.Filled" Disabled="@IsAnyError" Color="Color.Primary" DisableElevation="true" OnClick="@(async ()=> await this.SubmitForm())">Save</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" DisableElevation="true" OnClick="@(()=>form.ResetAsync())" Class="mx-2">Reset</MudButton>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    public IEnumerable<Product>? Products;
    public bool IsSuccess;
    public bool IsAnyError;
    public MudForm form;
    public string ValidationResult = "failed";

    private ProductFormModel Product { get; set; } = new ProductFormModel();
    private List<BreadcrumbItem> BreadCrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/"),
        new BreadcrumbItem("Products", href: "/products"),
        new BreadcrumbItem("Add Product", href: null, disabled: true)
    };


    public class ProductFormModel
    {
        [Required]
        [MinLength(8, ErrorMessage = "Name length must be more than 8.")]
        public string Name { get; set; }

        [Required]
        [MinLength(8, ErrorMessage = "Description length must be more than 8.")]
        public string Description { get; set; }

        [Required]
        public string ImageUrl { get; set; }
    }

    private void ValidChanged()
    {
        IsAnyError = !IsSuccess;
    }

    private async Task SubmitForm()
    {
        this.form.Validate().Wait();
        if (!this.IsSuccess)
        {
            this.ValidationResult = string.Join(";", form.Errors);
            return;
        }

        ValidationResult = "oke";
        var product = new Product()
            {
                Id = Guid.NewGuid().ToString(),
                Name = this.Product.Name,
                Description = this.Product.Description,
                ImageUrl = this.Product.ImageUrl
            };
        var result = await this.ProductService.AddProduct(product);
        if (result)
        {
            NavigationManager.NavigateTo("products");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        if (this.Products?.Any() != true)
        {
            this.Products = await this.ProductService.GetAllAsync();
        }
    }
}
